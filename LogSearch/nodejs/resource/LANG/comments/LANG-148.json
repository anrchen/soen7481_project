[Code changed, based on code below, but with different algorithm for sizing.
Please test this algorithm to see if it still helps with your performance issues.]