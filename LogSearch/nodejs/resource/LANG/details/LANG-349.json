{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12374094","self":"https://issues.apache.org/jira/rest/api/2/issue/12374094","key":"LANG-349","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310481","id":"12310481","key":"LANG","name":"Commons Lang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310481&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310481&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310481&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310481&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10260","id":"10260","description":"Apache Commons components","name":"Commons"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12312481","id":"12312481","description":"Bugfix release of the Lang1 codebase","name":"2.4","archived":true,"released":true,"releaseDate":"2008-03-18"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2007-07-18T22:14:01.578+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 16 04:26:17 UTC 2007","customfield_12310420":"147257","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_7725901790_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2007-10-16T04:26:17.790+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LANG-349/watchers","watchCount":0,"isWatching":false},"created":"2007-07-18T18:21:16.249+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12311706","id":"12311706","description":"","name":"2.0","archived":true,"released":true,"releaseDate":"2003-09-02"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-10-16T04:26:17.786+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"I used the ReflectionToStringBuilder on an object to output debugging messages to Log4j. If this object was picked up by two different threads and the toString() method was called at the same time in two different threads, a deadlock occurrs.\n\nHere is a stack trace from using jstack:\n\nThread 1172: (state = BLOCKED)\n - java.util.Vector.hashCode() @bci=0, line=938 (Interpreted frame)\n - java.util.HashMap.containsKey(java.lang.Object) @bci=6, line=377 (Compiled frame)\n - org.apache.commons.lang.builder.ReflectionToStringBuilder.toString() @bci=50, line=522 (Compiled frame)\n - org.apache.commons.lang.builder.ReflectionToStringBuilder.toString(java.lang.Object, org.apache.commons.lang.builder.ToStringStyle, boolean, java.lang.Class) @bci=12, line=265 (Interpreted frame)\n - org.apache.commons.lang.builder.ReflectionToStringBuilder.toString(java.lang.Object, org.apache.commons.lang.builder.ToStringStyle) @bci=4, line=197 (Interpreted frame)\n - org.apache.commons.lang.builder.ToStringBuilder.reflectionToString(java.lang.Object, org.apache.commons.lang.builder.ToStringStyle) @bci=2, line=170 (Interpreted frame)\n[...]\n\nThread 1191: (state = BLOCKED)\n - java.util.Vector.hashCode() @bci=0, line=938 (Interpreted frame)\n - java.util.HashMap.containsKey(java.lang.Object) @bci=6, line=377 (Compiled frame)\n - org.apache.commons.lang.builder.ReflectionToStringBuilder.toString() @bci=50, line=522 (Compiled frame)\n [...]\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"74782","customfield_12312823":null,"summary":"Deadlock using ReflectionToStringBuilder","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dapperdanman","name":"dapperdanman","key":"dapperdanman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David I.","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dapperdanman","name":"dapperdanman","key":"dapperdanman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David I.","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"java version \"1.5.0_10\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_10-b03)\nJava HotSpot(TM) Server VM (build 1.5.0_10-b03, mixed mode)\n\n>uname -a\nLinux fwjsfimat04 2.4.21-32.EL #1 SMP Fri Apr 15 21:02:58 EDT 2005 x86_64 x86_64 x86_64 GNU/Linux\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12374094/comment/12513736","id":"12513736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"body":"First step - attempt a reproduction. If that fails, then dig into the code and see if it's obvious.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-07-18T22:14:01.578+0000","updated":"2007-07-18T22:14:01.578+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12374094/comment/12521539","id":"12521539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm a little confused by the thread dump - ReflectionToStringBuilder.toString does not call HashMap.containsKey. Seems like a bunch of method calls are missing. Presumably this is because things are being compiled in and so that part of the trace vanishes.\n\nThis leaves me wondering where the HashMap.containsKey is coming from. Presumably it's from the object that is being reflected upon, and I'm not sure I see us having many options beyond either a) ignoring this bug as not fixable, or b) making the builders totally synchronized. \n\nAny thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-08-21T17:48:17.885+0000","updated":"2007-08-21T17:48:17.885+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12374094/comment/12521542","id":"12521542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dapperdanman","name":"dapperdanman","key":"dapperdanman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David I.","active":true,"timeZone":"Etc/UTC"},"body":"It does make sense that the reflection code isn't synchronized (since toString() isn't?). That might be the core issue. \n\nIt helps to know that you aren't using a HashMap internally. \n\nI could wrap the builder code in a synchronized block to prevent this. Does that sound like a good solution? If so, it would be nice to update the documentation to point out how toString and the reflection code isn't thread safe. \n\nWould it be possible to have add a \"thread-safe\" version that synchronizes on each variable (or the whole class) before reading it during the reflection process? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dapperdanman","name":"dapperdanman","key":"dapperdanman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David I.","active":true,"timeZone":"Etc/UTC"},"created":"2007-08-21T17:59:24.184+0000","updated":"2007-08-21T17:59:24.184+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12374094/comment/12528983","id":"12528983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"body":"Without being very deep into the code - wrapping the builder usage does seem like a good solution. Did you give that a try?\n\nThat's something that the documentation could suggest users do. \n\nI imagine a synchronized version of the ToStringBuilders could definitely be done - just a question of putting together the patch etc :) I'm not sure if it would get you much that putting a lock around the ToStringBuilder usage wouldn't have given you.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-09-20T05:35:08.626+0000","updated":"2007-09-20T05:35:08.626+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12374094/comment/12529106","id":"12529106","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dapperdanman","name":"dapperdanman","key":"dapperdanman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David I.","active":true,"timeZone":"Etc/UTC"},"body":"I have not given it a try yet, but it makes sense and sounds like it would work.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dapperdanman","name":"dapperdanman","key":"dapperdanman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David I.","active":true,"timeZone":"Etc/UTC"},"created":"2007-09-20T13:30:28.127+0000","updated":"2007-09-20T13:30:28.127+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12374094/comment/12535055","id":"12535055","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm going to mark this as a wontfix; please reopen if you think there's more to do David, but it sounds like things are good.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bayard","name":"bayard","key":"bayard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Henri Yandell","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-10-16T04:26:17.775+0000","updated":"2007-10-16T04:26:17.775+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/LANG-349/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0d67j:"}}